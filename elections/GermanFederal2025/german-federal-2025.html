<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Bundestagswahl 2025 – Korrelationen</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .controls { margin: 20px 0; padding: 10px; background: #f0f0f0; border-radius: 5px; }
        .chart-container { width: 90%; margin: 0 auto; }
        select { margin: 0 10px; padding: 5px; }
    </style>
</head>
<body>
    <h1>Bundestagswahl 2025: Korrelationen</h1>
    <p>Wähle eine Partei und einen Sozialindikator, um die Daten zu visualisieren.</p>

    <div class="controls">
        <label for="party-select">Partei:</label>
        <select id="party-select"></select>

        <label for="indicator-select">Sozialindikator:</label>
        <select id="indicator-select"></select>

        <button onclick="loadData()">Daten laden</button>
    </div>

    <div class="chart-container">
        <canvas id="correlationChart"></canvas>
    </div>

    <script>
        let correlationChart;
        let electionData = [];
        let structuralData = [];
        let electionHeaders = [];
        let structuralHeaders = [];

        // CSV-Datei laden und Header extrahieren
        async function loadCSV(file) {
            const response = await fetch(file);
            const text = await response.text();
            const parsed = Papa.parse(text, { header: true, dynamicTyping: true });
            return {
                data: parsed.data,
                headers: parsed.meta.fields  // Spaltennamen (Header)
            };
        }

        // Dropdowns mit Daten aus CSV füllen
        async function initDropdowns() {
            // Wahlergebnisse laden
            const electionResult = await loadCSV("wahlergebnisse_btw_2025.csv");
            electionData = electionResult.data;
            electionHeaders = electionResult.headers;

            // Strukturdaten laden
            const structuralResult = await loadCSV("strukturdaten.csv");
            structuralData = structuralResult.data;
            structuralHeaders = structuralResult.headers;

            // Dropdown für Parteien füllen (ohne "Wahlkreis")
            const partySelect = document.getElementById("party-select");
            electionHeaders.forEach(header => {
                if (header !== "Wahlkreis") {  // "Wahlkreis" ist keine Partei
                    const option = document.createElement("option");
                    option.value = header;
                    option.textContent = header;
                    partySelect.appendChild(option);
                }
            });

            // Dropdown für Indikatoren füllen (ohne "Wahlkreis")
            const indicatorSelect = document.getElementById("indicator-select");
            structuralHeaders.forEach(header => {
                if (header !== "Wahlkreis") {
                    const option = document.createElement("option");
                    option.value = header;
                    option.textContent = header;
                    indicatorSelect.appendChild(option);
                }
            });
        }

        // Daten für ausgewählte Partei/Indikator laden
        function loadData() {
            const party = document.getElementById("party-select").value;
            const indicator = document.getElementById("indicator-select").value;

            // Kombiniere Daten für den Chart
            const combinedData = electionData.map((wahl, i) => ({
                wahlkreis: wahl.Wahlkreis,
                wahlergebnis: wahl[party],
                indikator: structuralData[i][indicator]
            }));

            drawChart(combinedData, party, indicator);
        }

        // Chart.js-Diagramm erstellen (wie zuvor)
        function drawChart(data, party, indicator) {
            const ctx = document.getElementById("correlationChart").getContext("2d");
            if (correlationChart) correlationChart.destroy();

            correlationChart = new Chart(ctx, {
                type: "scatter",
                data: {
                    datasets: [{
                        label: `${party} vs. ${indicator}`,
                        data: data.map(item => ({
                            x: item.indikator,
                            y: item.wahlergebnis
                        })),
                        backgroundColor: "rgba(75, 192, 192, 0.6)",
                        borderColor: "rgba(75, 192, 192, 1)",
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { title: { display: true, text: `Korrelation: ${party} vs. ${indicator}` } },
                    scales: {
                        x: { title: { display: true, text: indicator } },
                        y: { title: { display: true, text: `Wahlergebnis ${party} (%)` }, beginAtZero: true }
                    }
                }
            });
        }

        // Seite initialisieren
        window.onload = initDropdowns;
    </script>
</body>
</html>
